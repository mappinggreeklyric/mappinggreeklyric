<!DOCTYPE html>
<html>
  <head>
    <title>Mapping Greek Lyric: Places, Travel, Geographical Imaginary</title>
    
    <link type="text/css" rel="stylesheet" href="orbis.css" />
    <link type="text/css" rel="stylesheet" href="lyricmapping.css" />
    <link type="text/css" rel="stylesheet" href="chosen.min.css" />
    <link rel="stylesheet" href="css/iThing.css" type="text/css" />
    <link href='https://fonts.googleapis.com/css?family=Gentium+Basic:400,700' rel='stylesheet' type='text/css'>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>

	
	<!--Custom html for the infowindow customization-->
    <!--You can write simple html or use Mustache templates http://mustache.github.com/-->
    <!--Content.data contains the field info-->
	<!--Content.data is determined by the UI on the cartodb webpage.-->
	<!--In order for the following to work, you must run a query that gives the columns selected_number and selected_names, and then select those-->

	<link rel="stylesheet" href="cartodb.css" />
	<!--[if lte IE 8]>
		<link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/themes/css/cartodb.ie.css" />
	<![endif]-->
	<!-- bootstrap is not playing well with the orbis box-->
	<!-- <link href="bootstrap/css/bootstrap.css" rel="stylesheet">    --> 
</head>
<body>

  <div id="essayBox">
    <div id="essayTitle" onclick="closeEssay()">HELP BOX</div>
    <div id="essayContent"></div>
    <div id="essayCloseButton" onclick="closeEssay()" >X</div>
    <div style="width:100%;height:100%;" onclick="closeEssay()">
    </div>
  </div>

  <div id="map"></div>
    
  <div class="controlsDiv" id="controlbar">
    <div id="controlbarScroller";>
      
    <div id="modeSelection">
      <div class="mainlinksDiv" >
		<a style="border-bottom: 4px solid rgba(199,47,42,.5);" class="mainlinks" href="bubblemap.html?visited=1">PLACES</a>
      </div>
      <div class="mainlinksDiv">
		<a class="mainlinks" href="linemap.html">TRAVEL</a>
      </div>
      <div class="mainlinksDiv" style="-webkit-box-flex: 2; -moz-box-flex: 2; -webkit-flex: 2; -ms-flex: 2; flex: 2;">
		<a class="mainlinks" href="imaginary.html">GEOGRAPHICAL IMAGINARY</a>
      </div>
    </div>
    
    <div class="buttonContainer" style="background: rgba(255,255,255,0);">            
      <fieldset style="border: none;" id="cityForm" class="priorityForm">
        <div style="color:black;padding-right:5px;display: inline-block;margin-top: 3px; font-weight: bold;" >PLACE OF: </div>
        <input type="radio" value="0" name="city" id="relationship_1">
        <label for="relationship_1" class="priority-picker-label">ORIGIN</label>
        <input type="radio" value="1" name="city" id="relationship_3" checked>
        <label for="relationship_3" class="priority-picker-label">ACTIVITY</label>
      </fieldset>
    </div>

   <div class="buttonContainer" style="background: rgba(255,255,255,0); height: 100px;">            
      <fieldset style="border: none;" id="cityForm" class="priorityForm">
        <div style="color:black;padding-right:5px;display: inline-block;margin-top: 3px; font-weight: bold;" >POETS WITH UNKNOWN TRAVELS: </div>
		<input type="radio" value="0" name="city" id="poet_36">
		<label for="poet_36" class="instrument-picker-label">Alkaios (â‰  Alcaeus)</label>

		<input type="radio" value="0" name="city" id="poet_35">
		<label for="poet_35" class="instrument-picker-label">Alkimakhos</label>

		<input type="radio" value="0" name="city" id="poet_8">
		<label for="poet_8" class="instrument-picker-label">Antigenes</label>

		<input type="radio" value="0" name="city" id="poet_96">
		<label for="poet_96" class="instrument-picker-label">Apollodorus</label>

		<input type="radio" value="0" name="city" id="poet_37">
		<label for="poet_37" class="instrument-picker-label">Arignotos</label>

		<input type="radio" value="0" name="city" id="poet_39">
		<label for="poet_39" class="instrument-picker-label">Ariphrades</label>

		<input type="radio" value="0" name="city" id="poet_9">
		<label for="poet_9" class="instrument-picker-label">Aristarkhos</label>

		<input type="radio" value="0" name="city" id="poet_57">
		<label for="poet_57" class="instrument-picker-label">Aristokleitos (Aristokleides)</label>

		<input type="radio" value="0" name="city" id="poet_56">
		<label for="poet_56" class="instrument-picker-label">Arkhelaos</label>

		<input type="radio" value="0" name="city" id="poet_10">
		<label for="poet_10" class="instrument-picker-label">Arkhestratos</label>

		<input type="radio" value="0" name="city" id="poet_19">
		<label for="poet_19" class="instrument-picker-label">Arrhibaeus</label>

		<input type="radio" value="0" name="city" id="poet_99">
		<label for="poet_99" class="instrument-picker-label">Asius</label>

		<input type="radio" value="0" name="city" id="poet_102">
		<label for="poet_102" class="instrument-picker-label">Cedeides</label>

		<input type="radio" value="0" name="city" id="poet_4">
		<label for="poet_4" class="instrument-picker-label">Cinesias</label>

		<input type="radio" value="0" name="city" id="poet_105">
		<label for="poet_105" class="instrument-picker-label">Critias</label>

		<input type="radio" value="0" name="city" id="poet_106">
		<label for="poet_106" class="instrument-picker-label">Cydias (Kydides?)</label>

		<input type="radio" value="0" name="city" id="poet_41">
		<label for="poet_41" class="instrument-picker-label">Dexitheus</label>

		<input type="radio" value="0" name="city" id="poet_60">
		<label for="poet_60" class="instrument-picker-label">Dikaiogenes</label>

		<input type="radio" value="0" name="city" id="poet_61">
		<label for="poet_61" class="instrument-picker-label">Dion</label>

		<input type="radio" value="0" name="city" id="poet_21">
		<label for="poet_21" class="instrument-picker-label">Dionysius of Thebes</label>

		<input type="radio" value="0" name="city" id="poet_64">
		<label for="poet_64" class="instrument-picker-label">Epameinondas</label>

		<input type="radio" value="0" name="city" id="poet_66">
		<label for="poet_66" class="instrument-picker-label">Euneidai</label>

		<input type="radio" value="0" name="city" id="poet_42">
		<label for="poet_42" class="instrument-picker-label">Exekestides</label>

		<input type="radio" value="0" name="city" id="poet_68">
		<label for="poet_68" class="instrument-picker-label">Exekestos</label>

		<input type="radio" value="0" name="city" id="poet_12">
		<label for="poet_12" class="instrument-picker-label">Gnesippos</label>

		<input type="radio" value="0" name="city" id="poet_70">
		<label for="poet_70" class="instrument-picker-label">Hieronymos</label>

		<input type="radio" value="0" name="city" id="poet_159">
		<label for="poet_159" class="instrument-picker-label">Hybrias</label>

		<input type="radio" value="0" name="city" id="poet_75">
		<label for="poet_75" class="instrument-picker-label">Kleitagora</label>

		<input type="radio" value="0" name="city" id="poet_76">
		<label for="poet_76" class="instrument-picker-label">Kleomenes</label>

		<input type="radio" value="0" name="city" id="poet_46">
		<label for="poet_46" class="instrument-picker-label">Konnos</label>

		<input type="radio" value="0" name="city" id="poet_119">
		<label for="poet_119" class="instrument-picker-label">Lamprocles</label>

		<input type="radio" value="0" name="city" id="poet_28">
		<label for="poet_28" class="instrument-picker-label">Lamynthios </label>

		<input type="radio" value="0" name="city" id="poet_91">
		<label for="poet_91" class="instrument-picker-label">Melanthios</label>

		<input type="radio" value="0" name="city" id="poet_48">
		<label for="poet_48" class="instrument-picker-label">Meles</label>

		<input type="radio" value="0" name="city" id="poet_53">
		<label for="poet_53" class="instrument-picker-label">Meletos of Athens</label>

		<input type="radio" value="0" name="city" id="poet_122">
		<label for="poet_122" class="instrument-picker-label">Mimnermus</label>

		<input type="radio" value="0" name="city" id="poet_123">
		<label for="poet_123" class="instrument-picker-label">Myrtis</label>

		<input type="radio" value="0" name="city" id="poet_15">
		<label for="poet_15" class="instrument-picker-label">Niko-</label>

		<input type="radio" value="0" name="city" id="poet_16">
		<label for="poet_16" class="instrument-picker-label">Nikostratos</label>

		<input type="radio" value="0" name="city" id="poet_29">
		<label for="poet_29" class="instrument-picker-label">Oeniades</label>

		<input type="radio" value="0" name="city" id="poet_124">
		<label for="poet_124" class="instrument-picker-label">Olympus</label>

		<input type="radio" value="0" name="city" id="poet_17">
		<label for="poet_17" class="instrument-picker-label">Pantakles</label>

		<input type="radio" value="0" name="city" id="poet_25">
		<label for="poet_25" class="instrument-picker-label">Philoxenus of Leucas</label>

		<input type="radio" value="0" name="city" id="poet_127">
		<label for="poet_127" class="instrument-picker-label">Phocylides</label>

		<input type="radio" value="0" name="city" id="poet_82">
		<label for="poet_82" class="instrument-picker-label">Pindar, son of Skopelinos</label>

		<input type="radio" value="0" name="city" id="poet_150">
		<label for="poet_150" class="instrument-picker-label">Polychares</label>

		<input type="radio" value="0" name="city" id="poet_83">
		<label for="poet_83" class="instrument-picker-label">Praxilla</label>

		<input type="radio" value="0" name="city" id="poet_84">
		<label for="poet_84" class="instrument-picker-label">Scythinus</label>

		<input type="radio" value="0" name="city" id="poet_85">
		<label for="poet_85" class="instrument-picker-label">Sophokles, son of Ariston</label>

		<input type="radio" value="0" name="city" id="poet_86">
		<label for="poet_86" class="instrument-picker-label">Stesandros</label>

		<input type="radio" value="0" name="city" id="poet_54">
		<label for="poet_54" class="instrument-picker-label">Telesilla</label>

		<input type="radio" value="0" name="city" id="poet_22">
		<label for="poet_22" class="instrument-picker-label">Tellen</label>

		<input type="radio" value="0" name="city" id="poet_87">
		<label for="poet_87" class="instrument-picker-label">Theano</label>

		<input type="radio" value="0" name="city" id="poet_143">
		<label for="poet_143" class="instrument-picker-label">Theognis</label>

		<input type="radio" value="0" name="city" id="poet_146">
		<label for="poet_146" class="instrument-picker-label">Tynnichus</label>

		<input type="radio" value="0" name="city" id="poet_147">
		<label for="poet_147" class="instrument-picker-label">Xanthus</label>
      </fieldset>
    </div>
      
    <div class="buttonContainer" style="background: rgba(255,255,255,0);">            
      <fieldset style="border: none;" id="genreForm" class="genreForm">
        <div style="color:black;padding-right:5px;display: inline-block;margin-top: 3px; font-weight: bold;" >GENRE: </div>
        <input type="radio" value="0" name="city" id="genre_2">
        <label for="genre_2" class="genre-picker-label">Dithyramb</label>
	
        <input type="radio" value="1" name="city" id="genre_3">
        <label for="genre_3" class="genre-picker-label">Elegy</label>
	
        <input type="radio" value="2" name="city" id="genre_4">
        <label for="genre_4" class="genre-picker-label">Enkomion</label>
	
		<input type="radio" value="0" name="city" id="genre_5">
        <label for="genre_5" class="genre-picker-label">Epigram</label>
	
        <input type="radio" value="2" name="city" id="genre_16">
        <label for="genre_16" class="genre-picker-label">Epinician</label>
	
        <input type="radio" value="1" name="city" id="genre_6">
        <label for="genre_6" class="genre-picker-label">Hymn</label>
	
        <input type="radio" value="2" name="city" id="genre_22">
        <label for="genre_22" class="genre-picker-label">Hyporchema</label>
	
        <input type="radio" value="2" name="city" id="genre_11">
        <label for="genre_11" class="genre-picker-label">Iambos</label>
	
        <input type="radio" value="2" name="city" id="genre_24">
        <label for="genre_24" class="genre-picker-label">Lament</label>
	
		<input type="radio" value="0" name="city" id="genre_7">
        <label for="genre_7" class="genre-picker-label">Nome</label>
	
        <input type="radio" value="1" name="city" id="genre_8">
        <label for="genre_8" class="genre-picker-label">Paean</label>
	
        <input type="radio" value="2" name="city" id="genre_13">
        <label for="genre_13" class="genre-picker-label">Partheneion</label>
	
        <input type="radio" value="2" name="city" id="genre_9">
        <label for="genre_9" class="genre-picker-label">Prooimoin</label>
	
		<input type="radio" value="2" name="city" id="genre_10">
        <label for="genre_10" class="genre-picker-label">Prosodion</label>
	
		<input type="radio" value="2" name="city" id="genre_12">
        <label for="genre_12" class="genre-picker-label">Skolia</label>
		
		<input type="radio" value="2" name="city" id="genre_30">
        <label for="genre_30" class="genre-picker-label">Unclassified Melic</label>
      </fieldset>
    </div>
      
	</div>
    
    <div style="width: 320px; margin: 0 auto; margin-top: 2px" id="slider"></div>	

  </div>
  <!-- end of controlbar div    -->
  
  <div id="attribution">
	<i>Mapping Greek Lyric: Places, Travel, Geographical Imaginary.</i> D. Driscoll, I. McMullin, S. Sansom, S. Brennan-McMahon, A. Waller, A.-E. Peponi.
  </div>

  <a href="bubblemap.html">
	  <div id="home" class="home">
	  </div>
  </a>
	
    <!-- include google maps library *before* load cartodb.js -->
    <script src="https://maps.googleapis.com/maps/api/js?sensor=false"></script>
    <!-- include cartodb.js library -->
	<!-- <script src="test-cartodb.js"></script>  -->
   <script src="cartodb.js"></script>
    
    <script src="jquery-1.11.2.js"></script>
    <script src="jquery-ui.js"></script>
    <script src="jQRangeSlider-withRuler-min.js"></script>
	<script src="d3.v3.min.js" type="text/javascript"></script>
	<script src="orbis.js" type="text/javascript"></script>
	<script src="lyric_mapping.js" type="text/javascript"></script>
	
    <script>
    //<!--
      $("#slider").rangeSlider({
        bounds:{min: -800, max: -400},
		defaultValues:{min: -800, max: -400},
		range: {min: 25},  
		step: 50,
		arrows: false,
		formatter:function(val){
			  var value = -val;
			  return value.toString() + " BCE";
		},
		scales: [
		// Primary scale
		{
		  first: function(val){ return val; },
		  next: function(val){ return val + 50; },
		  stop: function(val){ return false; },
		  label: function(val){ return -val; },
		  format: function(tickContainer, tickStart, tickEnd){ 
		  tickContainer.addClass("myCustomClass");
		  }
		}]
	  });
    //-->
    </script>
	
    <script>
      // create layer selector
      function createSelector(layer) {
        var sql = new cartodb.SQL({ user: 'dfdrisco' });

        var $options = $('#controlbar input');
        $options.click(function(e) {        
		  updateQuery(layer, $("#slider").rangeSlider("values"));
        });
		$("#slider").bind("valuesChanged", function(e, data) {
		  if ($("#controlbar input:checked").length > 0) {}
		  else $('#relationship_3').prop('checked', true);
		  updateQuery(layer, $("#slider").rangeSlider("values"));
		});
      }
	  
	function getParameterByName(name) {
		name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
		var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"),
			results = regex.exec(location.search);
		return results === null ? "" : decodeURIComponent(results[1].replace(/\+/g, " "));
	}
	  
	function updateQuery(layer, dateValues) {
	
	/* this function creates and calls a complex sql query based on selected items */
	/* when an item is clicked, it checks the status of each button and creates an appropriate sql query */
	/* it is super gross */
	/* the sql query is composed of several embedded joins. first poets & poet_cities */
	/* then the result of that with dates, genres, instruments, and cities in turn */
	/* the code is somewhat repetitive and it's probably possible to shrink it with some function calls but it sounds like too much work */
		var firstCall = true;
		var birthCall;
		var i = 0;
		
		layer.setInteraction(true);
		
		var query;
		
		// activity query
		if($('#relationship_3').is(':checked')) {
		  query = "SELECT DISTINCT cities.*, Sum(jc.selected_number) AS selected_number, String_agg(jc.selected_names, '</p>') AS selected_names, String_agg(jc.selected_sources, '</p>') AS selected_sources, 'NON-NATIVE LYRIC ACTIVITY IN ' AS relationship_text_1, '' AS relationship_text_2 FROM cities,(SELECT r.cityid, Count(r.cityid) AS selected_number, (string_agg('<span style=\"color:#B81609\">'||r.poets_cities_rank||'</span>. '||r.poet_name, ', ' order BY r.poets_cities_rank)) AS selected_names, ('<h4 style=\"color:#AAAAAA\">Non-native Poets</h4>'||string_agg('<p><span style=\"color:#B81609\">'||r.poets_cities_rank||'</span>. '||r.details_name||'<br>Dates: '||r.dates||'<br>Genre(s): '||r.gn||'<br>Source(s): '||r.sources||'<br><a id=\"link_to_citation_'||r.poets_cities_rank||'\" href=\"\" >Citation</a>'||'<br><span id=\"citation_'||r.poets_cities_rank||'\" style=\"display:none;\">'||r.source_citation||': \"'||r.source_translation||'\" (trans. '||r.source_translator||')<br>'||r.source_greektext||'</span>' , '</p>' ORDER BY r.poets_cities_rank)) AS selected_sources FROM cities,(SELECT pp.*, rank() OVER (partition BY pp.cityid ORDER BY pp.poet_name ASC) AS poets_cities_rank FROM(SELECT DISTINCT pp.* FROM(SELECT poets.poetid, poets.poet_name, poets.details_name, poets.sources, poets.gn, poets.dates, poets_cities.cityid, poets_cities.source_citation, poets_cities.source_explicit, poets_cities.source_greektext, poets_cities.source_notes, poets_cities.source_translation, poets_cities.source_translator, poets_cities.source_work FROM(SELECT poets.*, COALESCE(poets_genres.gn, 'Unknown') AS gn FROM poets LEFT OUTER JOIN(SELECT sg.poetid, string_agg(sg.genre, ', ') AS gn FROM(SELECT * FROM genres WHERE genreid IN ('2','3','4','5','16','18','6','22','11','24','7','8','13','9','10','12','30','31','32') ORDER BY (genreid=32) DESC, (genreid=30) DESC, genre) sg GROUP BY sg.poetid)poets_genres ON poets.poetid=poets_genres.poetid) poets, poets_cities WHERE poets.poetid=poets_cities.poetid AND(poets_cities.nativeid=2 OR poets_cities.nativeid=3) ORDER BY poet_name ASC)pp, dates WHERE pp.poetid=dates.poetid AND (dates.date <= ";
		  query = query + -dateValues.min + " AND dates.date >= " + -dateValues.max;
		  query = query + "))pp ORDER BY pp.cityid, pp.poet_name) r WHERE cities.cityid=r.cityid GROUP BY r.cityid, cities.city_name UNION ALL SELECT r.cityid, count(r.cityid) AS selected_number, ('<h4 style=\"color:#AAAAAA\">NATIVE LYRIC ACTIVITY IN '||cities.city_name||'</h4><p>'||string_agg('<span style=\"color:#B81609\">'||r.poets_cities_rank||'</span>. '||r.poet_name, ', ' ORDER BY r.poets_cities_rank)) AS selected_names, ('<h4 style=\"color:#AAAAAA\">Native poets</h4>'||string_agg('<p><span style=\"color:#B81609\">'||r.poets_cities_rank||'</span>. '||r.details_name||'<br>Dates: '||r.dates||'<br>Genre(s): '||r.gn||'<br>Source(s): '||r.sources||'<br><a id=\"link_to_citation_n'||r.poets_cities_rank||'\" href=\"\" >Citation</a>'||'<br><span id=\"citation_n'||r.poets_cities_rank||'\" style=\"display:none;\">'||r.source_citation||': \"'||r.source_translation||'\" (trans. '||r.source_translator||')<br>'||r.source_greektext||r.abc||'</span>' , '</p>' ORDER BY r.poets_cities_rank)) AS selected_sources FROM cities,(SELECT pp.*, rank() OVER (partition BY pp.cityid ORDER BY pp.poet_name ASC) AS poets_cities_rank FROM(SELECT DISTINCT pp.* FROM(SELECT poets.poetid, poets.poet_name, poets.details_name, poets.sources, poets.gn, poets.dates, poets_cities.cityid, poets_cities.source_citation, poets_cities.source_explicit, poets_cities.source_greektext, poets_cities.source_notes, poets_cities.source_translation, poets_cities.source_translator, poets_cities.source_work, poets_cities.abc FROM(SELECT poets.*, COALESCE(poets_genres.gn, 'Unknown') AS gn FROM poets LEFT OUTER JOIN(SELECT sg.poetid, string_agg(sg.genre, ', ') AS gn FROM(SELECT * FROM genres WHERE genreid IN ('2','3','4','5','16','18','6','22','11','24','7','8','13','9','10','12','30','31','32') ORDER BY (genreid=32) DESC, (genreid=30) DESC, genre) sg GROUP BY sg.poetid)poets_genres ON poets.poetid=poets_genres.poetid) poets,(SELECT poets_cities.*, COALESCE(abc.abc, '') AS abc FROM poets_cities LEFT OUTER JOIN(SELECT poets_cities.poetid, poets_cities.cityid, ('<br>See also: '||string_agg(bc.city_name, ', ' ORDER BY bc.city_name ASC)) AS abc FROM(SELECT * FROM poets_cities WHERE poets_cities.nativeid=1) poets_cities,(SELECT cities.city_name, poets_cities.cityid, poets_cities.poetid FROM cities, poets_cities WHERE cities.cityid=poets_cities.cityid AND poets_cities.nativeid=1)bc WHERE poets_cities.poetid=bc.poetid AND poets_cities.cityid != bc.cityid GROUP BY poets_cities.poetid, poets_cities.cityid) abc ON poets_cities.poetid=abc.poetid AND poets_cities.cityid=abc.cityid)poets_cities WHERE poets.poetid=poets_cities.poetid AND(poets_cities.nativeid=1) ORDER BY poet_name ASC)pp, dates WHERE pp.poetid=dates.poetid AND (dates.date <= "
		  query=query + -dateValues.min + " AND dates.date >= " + -dateValues.max;
		  query=query + "))pp ORDER BY pp.cityid, pp.poet_name) r WHERE cities.cityid=r.cityid GROUP BY r.cityid, cities.city_name) jc WHERE cities.cityid=jc.cityid GROUP BY cities.cityid, cities.cartodb_id, cities.the_geom, cities.the_geom_webmercator, cities.infowindow_name";
		}
		// origin query
		else {
			firstCall = true;
			for (i=2; i <= 35; i++) {		
			  if($('#genre_'+i).is(':checked')) {
					  query = "SELECT cities.*, Count(rank_players.cityid) AS selected_number, (string_agg('<span style=\"color:#B81609\">' || rank_players.poets_cities_rank || '</span>. ' || rank_players.poet_name, ', ' order BY rank_players.poets_cities_rank)) AS selected_names, (string_agg('<p><span style=\"color:#B81609\">' || rank_players.poets_cities_rank || '</span>. ' || rank_players.details_name || '<br>Dates: ' || rank_players.date_names || '<br>Genre(s): ' || rank_players.gn || '<br>Source: ' || rank_players.g_source_citation || ': \"' || rank_players.g_source_translation || '\" (trans. ' || rank_players.g_source_translator || ')<br>' || rank_players.g_source_greektext , '</p>' ORDER BY rank_players.poets_cities_rank)) AS selected_sources, ";
					  firstCall = false;
			  }
		  }
		  if(firstCall==true) {
			  query = "SELECT cities.*, Count(rank_players.cityid) AS selected_number, (string_agg('<span style=\"color:#B81609\">' || rank_players.poets_cities_rank || '</span>. ' || rank_players.poet_name, ', ' order BY rank_players.poets_cities_rank)) AS selected_names, (string_agg('<p><span style=\"color:#B81609\">' || rank_players.poets_cities_rank || '</span>. ' || rank_players.details_name || '<br>Dates: ' || rank_players.date_names || '<br>Genre(s): ' || rank_players.gn || '<br>Source(s): ' || rank_players.sources || '<br><a id=\"link_to_citation_'||rank_players.poets_cities_rank||'\" href=\"\" >Citation</a>' || '<br><span id=\"citation_' || rank_players.poets_cities_rank || '\" style=\"display:none;\">' || rank_players.source_citation || ': \"' || rank_players.source_translation || '\" (trans. ' || rank_players.source_translator || ')<br>' || rank_players.source_greektext || rank_players.alternative_birth_cities || '</span>' , '</p>' ORDER BY rank_players.poets_cities_rank)) AS selected_sources, ";

		  }
  
		  //add relationship text based on what's selected	
		  firstCall = true;
		  for (i=1; i <= 35; i++) {		
			  if($('#genre_'+i).is(':checked')) {
			  		firstCall = false;
					query = query + "'Poets born in ' as relationship_text_1, ";
			  }	
			  if ($('#instrument_1').is(':checked')) {
			  		firstCall = false;
			  		query = query + "'Poets born in ' as relationship_text_1, ";
			  }
		  }
		  if($('#relationship_1').is(':checked')) {
			  		firstCall = false;
			  		query = query + "'Poets born in ' as relationship_text_1, ";		  	
		  }
		  if(firstCall == true) {
		  		query = query + "'Poet active in ' as relationship_text_1, ";
		  }

		  if ($('#genre_2').is(':checked')) query = query + "' and associated with dithyramb' as relationship_text_2 ";
		  else if ($('#genre_3').is(':checked')) query = query + "' and associated with elegy' as relationship_text_2 ";
		  else if ($('#genre_4').is(':checked')) query = query + "' and associated with enkomion' as relationship_text_2 ";
		  else if ($('#genre_5').is(':checked')) query = query + "' and associated with epigram' as relationship_text_2 ";
		  else if ($('#genre_6').is(':checked')) query = query + "' and associated with hymn' as relationship_text_2 ";
		  else if ($('#genre_7').is(':checked')) query = query + "' and associated with nome' as relationship_text_2 ";
		  else if ($('#genre_8').is(':checked')) query = query + "' and associated with paean' as relationship_text_2 ";
		  else if ($('#genre_9').is(':checked')) query = query + "' and associated with prooimion' as relationship_text_2 ";
		  else if ($('#genre_10').is(':checked')) query = query + "' and associated with prosodion' as relationship_text_2 ";
		  else if ($('#genre_11').is(':checked')) query = query + "' and associated with iambos' as relationship_text_2 ";
		  else if ($('#genre_12').is(':checked')) query = query + "' and associated with skolia' as relationship_text_2 ";
		  else if ($('#genre_13').is(':checked')) query = query + "' and associated with partheneion' as relationship_text_2 ";
		  else if ($('#genre_14').is(':checked')) query = query + "' and associated with tragedy' as relationship_text_2 ";
		  else if ($('#genre_15').is(':checked')) query = query + "' and associated with epic' as relationship_text_2 ";
		  else if ($('#genre_16').is(':checked')) query = query + "' and associated with epinician' as relationship_text_2 ";
		  else if ($('#genre_17').is(':checked')) query = query + "' and associated with comedy' as relationship_text_2 ";
		  else if ($('#genre_18').is(':checked')) query = query + "' and associated with epode' as relationship_text_2 ";
		  else if ($('#genre_19').is(':checked')) query = query + "' and associated with parody' as relationship_text_2 ";
		  else if ($('#genre_20').is(':checked')) query = query + "' and associated with choral dance' as relationship_text_2 ";
		  else if ($('#genre_21').is(':checked')) query = query + "' and associated with satyr' as relationship_text_2 ";
		  else if ($('#genre_22').is(':checked')) query = query + "' and associated with hyporchema' as relationship_text_2 ";
		  else if ($('#genre_23').is(':checked')) query = query + "' and associated with komos' as relationship_text_2 ";
		  else if ($('#genre_24').is(':checked')) query = query + "' and associated with lament' as relationship_text_2 ";
		  else if ($('#genre_25').is(':checked')) query = query + "' and associated with prose' as relationship_text_2 ";
		  else if ($('#genre_26').is(':checked')) query = query + "' and associated with eulogy' as relationship_text_2 ";
		  else if ($('#genre_27').is(':checked')) query = query + "' and associated with psogon' as relationship_text_2 ";
		  else if ($('#genre_28').is(':checked')) query = query + "' and associated with polemisterion' as relationship_text_2 ";
		  else if ($('#genre_29').is(':checked')) query = query + "' and associated with enoplion' as relationship_text_2 ";
		  else if ($('#genre_30').is(':checked')) query = query + "' and associated with unclassified melic' as relationship_text_2 ";
		  
		  else if ($('#instrument_1').is(':checked')) query = query + "' and associated with the aulos' as relationship_text_2 ";
		  else if ($('#instrument_2').is(':checked')) query = query + "' and associated with the kithara' as relationship_text_2 ";		
		  else if ($('#instrument_3').is(':checked')) query = query + "' and associated with the lyre' as relationship_text_2 ";
		  else if ($('#instrument_4').is(':checked')) query = query + "' and associated with the magadis' as relationship_text_2 ";	
		  else if ($('#instrument_5').is(':checked')) query = query + "' and associated with the barbitos' as relationship_text_2 ";		
		  else if ($('#instrument_6').is(':checked')) query = query + "' and associated with the sambyke' as relationship_text_2 ";
		  else if ($('#instrument_7').is(':checked')) query = query + "' and associated with the sacadion' as relationship_text_2 ";
		  
	  	else if($('#relationship_3').is(':checked')) {}
	  	else if($('#relationship_1').is(':checked')) query = query + "'' as relationship_text_2 ";

		  else query = query + "'' as relationship_text_2 ";
		  
		  query = query + "  FROM cities, ( SELECT instrument_players.*, rank() OVER (partition BY instrument_players.cityid ORDER BY instrument_players.poet_name ASC) AS poets_cities_rank FROM ( SELECT DISTINCT genre_players.* FROM ( SELECT DISTINCT date_players.* ";
		  
		  for (i=2; i <= 35; i++) {		
			  if($('#genre_'+i).is(':checked')) {
					  query = query + " , genres.source_citation as g_source_citation, genres.source_explicit as g_source_explicit, genres.source_greektext as g_source_greektext, genres.source_notes as g_source_notes, genres.source_translation as g_source_translation, genres.source_translator as g_source_translator, genres.source_work as g_source_work  ";
			  }
		  }
		  
		  query = query + " FROM ( SELECT DISTINCT pp.* FROM ( SELECT poets.poetid, poets.poet_name, poets.details_name, poets.sources, poets.gn, poets.dates AS date_names, poets_cities.cityid, poets_cities.source_citation, poets_cities.source_explicit, poets_cities.source_greektext, poets_cities.source_notes, poets_cities.source_translation, poets_cities.source_translator, poets_cities.source_work, poets_cities.alternative_birth_cities FROM ( SELECT poets.*, COALESCE(poets_genres.gn, 'Unknown') AS gn FROM poets LEFT OUTER JOIN ( SELECT sorted_genres.poetid, string_agg(sorted_genres.genre, ', ') AS gn FROM ( SELECT * FROM genres WHERE genreid = '2' OR genreid = '3' OR genreid = '4' OR genreid = '5' OR genreid = '16' OR genreid = '18' OR genreid = '6' OR genreid = '22' OR genreid = '11' OR genreid = '24' OR genreid = '7' OR genreid = '8' OR genreid = '13' OR genreid = '9' OR genreid = '10' OR genreid = '12' OR genreid = '30' OR genreid = '31' OR genreid = '32' ORDER BY (genreid = 32) DESC, (genreid = 30) DESC, genre) sorted_genres GROUP BY sorted_genres.poetid) poets_genres ON poets.poetid = poets_genres.poetid) poets, (select poets_cities.*, coalesce(alternative_birth_cities.alternative_birth_cities, '') as alternative_birth_cities from ";
		  
		  /* first choose relationship to place; choose death or activity over birth if multiple activities associated with one city */
		  
		  if($('#relationship_3').is(':checked')) {
			query = query + " (select poets_cities.* from poets_cities, (SELECT poetid, cityid, max(relationshipid) as relationshipid from poets_cities group by poetid, cityid) poets_cities_max where poets_cities.poetid = poets_cities_max.poetid and poets_cities.cityid = poets_cities_max.cityid and poets_cities.relationshipid = poets_cities_max.relationshipid) poets_cities "
		  }
		  else {
			query = query + "poets_cities ";
		  }
		  
		  query = query + " LEFT OUTER JOIN (select poets_cities.poetid, poets_cities.cityid, ('<br>See also: ' || string_agg(birth_cities.city_name, ', ' order by birth_cities.city_name asc)) as alternative_birth_cities from (select * from poets_cities where poets_cities.relationshipid = 1) poets_cities, (SELECT cities.city_name, poets_cities.cityid, poets_cities.poetid FROM cities, poets_cities WHERE cities.cityid = poets_cities.cityid AND poets_cities.relationshipid = 1 ) birth_cities where poets_cities.poetid = birth_cities.poetid and poets_cities.cityid != birth_cities.cityid group by poets_cities.poetid, poets_cities.cityid) alternative_birth_cities ON poets_cities.poetid = alternative_birth_cities.poetid and poets_cities.cityid = alternative_birth_cities.cityid ) poets_cities WHERE poets.poetid = poets_cities.poetid ";
		  
		  birthCall = true;;

		  if($('#relationship_3').is(':checked')) {
		  	birthCall = false;
		  }
		  for (i=1; i <= 200; i++) {		
			  if($('#poet_'+i).is(':checked')) {
					  query = query + "AND (poets.poetid = " + i + ") ";
					  birthCall = false;
			  }	
		  }
		  if(birthCall == true) {
			query = query + "AND (relationshipid=1) ";
		  }
  
		  
		  /* embed this into the next layer up */
		  
		  query = query + [
			  "		ORDER BY poet_name ASC ",
			  "	) pp"
		  ].join("");
		  
		  /* then call dates */
		  
		  query = query + ", dates WHERE pp.poetid = dates.poetid AND (dates.date <= " + -dateValues.min + " AND dates.date >= " + -dateValues.max + ") ) date_players";
		  
		  /* now the custom genre call depending on what is selected */
		  
		  firstCall = true;
		  for (i=2; i <= 35; i++) {		
			  if($('#genre_'+i).is(':checked')) {
				  if(firstCall == true) {
					  firstCall = false;
					  query = query + [
					  ", genres ",
					  "WHERE date_players.poetid = genres.poetid ",
					  "			AND (genres.genreid = ",
					  i,
					  " "].join("");
				  }
				  else {
					  query = query + "OR genres.genreid = " + i + " ";
				  }
			  }
		  }
		  /* if a genre has been selected close the query */
		  if(firstCall == false) {
			  query = query + " ) ";
		  }
		  /* if no genre selected pass all of dates up unaltered */
		  
		  /* embed this into the next layer up */
		  
		  query = query + [
		  "	ORDER BY date_players.poet_name ASC ",
		  "	) genre_players " 
		  ].join("");
		  
		  /* now add the instruments */
  
		  firstCall = true;
		  for (i=1; i <= 7; i++) {		
			  if($('#instrument_'+i).is(':checked')) {
				  if(firstCall == true) {
					  firstCall = false;
					  query = query + [ 
					  ", instruments ",
					  "WHERE genre_players.poetid = instruments.poetid ",
					  "AND (instruments.instrumentid = ",
					  i,
					  " "
					  ].join("");
				  }
				  else {
					  query = query + "OR instruments.instrumentid = " + i + " ";
				  }
			  }
		  }
		  /* if an instrument has been selected close the call */
		  if(firstCall == false) {
			  query = query + " ) ";
		  }
		  /* if no instrument selected pass up genre players unaltered */		
		  
		  /* close out the query */
  
		  query = query + [
			  "		ORDER BY genre_players.poet_name ASC ",
			  "	) instrument_players ",
			  "  ORDER BY instrument_players.cityid, instrument_players.poet_name) rank_players ",
			  "  WHERE cities.cityid = rank_players.cityid ",
			  "  GROUP BY rank_players.cityid, cities.the_geom, cities.the_geom_webmercator, cities.city_name, ",
			  "			cities.cartodb_id "
		  ].join("");
		}
		
		layer.setQuery(query); 
		layer.setCartoCSS("#cities{ marker-fill: #B81609; marker-line-color: #FFF; marker-line-width: 2; marker-line-opacity: 1; marker-opacity: 0.9; marker-placement: point; marker-type: ellipse; marker-allow-overlap: true; marker-clip: false; marker-multi-policy: largest; } #cities [ selected_number <= 200] { marker-width: 28.0; } #cities [ selected_number <= 15] { marker-width: 25.0; } #cities [ selected_number <= 8] { marker-width: 23.3; } #cities [ selected_number <= 8] { marker-width: 21.7; } #cities [ selected_number <= 6] { marker-width: 20.0; } #cities [ selected_number <= 6] { marker-width: 18.3; } #cities [ selected_number <= 4] { marker-width: 16.7; } #cities [ selected_number <= 3] { marker-width: 15.0; } #cities [ selected_number <= 2] { marker-width: 13.3; } #cities [ selected_number <= 1] { marker-width: 10.0; } #cities::labels [selected_number>=8][zoom>5], [selected_number>=2][zoom>6], [selected_number>=1][zoom>7] { text-name: [city_name]; text-face-name: 'DejaVu Sans Book'; text-size: 15; text-fill: #000; text-allow-overlap: true; text-halo-fill: #FFF; text-halo-radius: 1; text-placement-type: simple; text-placements: \"N,S,E,W,NE,SE,NW,SW,16,14,12\"; text-dy: 3; text-dx: 3; }");
	}

	function ReverseDisplay(d) {
	  	if(document.getElementById(d).style.display == "none") { document.getElementById(d).style.display = "block"; }
	  	else { document.getElementById(d).style.display = "none"; }
	}
	
	function initalizeObserverOnInfowindowLinks() {
		// Select the node that will be observed for mutations
		const targetNode = document.getElementsByClassName('cartodb-infowindow')[0];

		// Options for the observer (which mutations to observe)
		const config = { childList: true, subtree: true };

		// Callback function to execute when mutations are observed
		// here we set the href of each link in the infowindow
		// to call the function ReverseDisplay defined above
		const callback = function(mutationList, observer) {
			let i = 1;
			while(document.getElementById('link_to_citation_' + i)) {
				const link = document.getElementById('link_to_citation_' + i);
				link.href = `javascript:ReverseDisplay('citation_${i}')`;
				i++;
			}
			i = 1;
			while(document.getElementById('link_to_citation_n' + i)) {
				const link = document.getElementById('link_to_citation_n' + i);
				link.href = `javascript:ReverseDisplay('citation_n${i}')`;
				i++;
			}
		};

		// Create an observer instance linked to the callback function
		const observer = new MutationObserver(callback);

		// Start observing the target node for configured mutations
		observer.observe(targetNode, config);
	}

    function main() {
        cartodb.createVis('map', 'http://128.199.4.121/user/dev/api/v2/viz/d6d19eb4-ff6a-4469-90e5-87b07aaa4a07/viz.json', {
          tiles_loader: true,
          center_lat: 38.9,
          center_lon: 26.38,
          zoom: 6,
        })
        .done(function(vis, layers) {
			// layer 0 is the base layer, layer 1 is cartodb layer
			
			// change attribution to us
			var map = vis.getNativeMap();
			map.attributionControl.removeAttribution(layers[0].getAttribution());
			map.attributionControl.removeAttribution(layers[1].getAttribution());
			
		  updateQuery(layers[1], $("#slider").rangeSlider("values"));
			layers[1].setInteraction(false);
			
			createSelector(layers[1]);
			if(getParameterByName('visited') != 1) createEssay("home");

			initalizeObserverOnInfowindowLinks();
        })
        .error(function(err) {
          console.log(err);
        });
      }

      window.onload = main;
    </script>
	
	<script>
	  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
	
	  ga('create', 'UA-66510812-1', 'auto');
	  ga('send', 'pageview');
	
	</script>
    
  </body>
</html>